<!DOCTYPE html>
<html>
  <head>
    <title>Chopsticks</title>
  </head>
  <body>
    <div>
      <div id="header">
        <p id="header-text">Let's play chopsticks! You go first</p>
      </div>
      <div id="app">
       <div class="container">
          <div class="grid-outer">
            <div id="p2lh-container" class="grid-inner">
              <img id="p2lh" draggable=false src="/static/hands.png" style="transform: translate(370px, 125px)">
            </div>
          </div>
          <div class="grid-outer">
            <div id="p2rh-container" class="grid-inner">
              <img id="p2rh" draggable=false src="/static/hands.png" style="transform: translate(370px, 125px)">
            </div>
          </div>
          <div class="grid-outer">
            <div id="p1lh-container" class="grid-inner">
              <img id="p1lh" draggable=false src="/static/hands.png" style="transform: translate(370px, 125px)">
            </div>
          </div>
          <div class="grid-outer">
            <div id="p1rh-container" class="grid-inner">
              <img id="p1rh" draggable=false src="/static/hands.png" style="transform: translate(370px, 125px)">
            </div>
          </div>
        </div> 
      </div>
    </div>
    <img class="img-cache" src="/static/hands_green.png">
    <img class="img-cache" src="/static/hands_red.png">

    <script>
      // Models
      const NUM_FINGERS = 5
      class Player {
        constructor(lh, rh) {
          this.lh = lh;
          this.rh = rh;
        }
        toObj() {
          return {
            "lh": this.Lh,
            "rh": this.Rh,
          };
        }
      }

      class GameState {
        constructor(p1, p2, turn) {
          this.p1 = p1;
          this.p2 = p2;
          this.T = turn;
        } 
        toObj() {
          return {
            "p1": this.p1.toObj(),
            "p2": this.p2.toObj(),
            "turn": this.T,
          };
        }
        toJson() {
          return JSON.stringify(this.toObj())
        }
      }

      class Move {
        constructor() {
          this.playerHand = null;
          this.receiverHand = null;
        }

        getPlayerHand() {
          return this.playerHand;
        }
        getReceiverHand() {
          return this.receiverHand;
        }

        setPlayerHand(ph) {
          this.playerHand = ph;
        }

        setReceiverHand(rh) {
          this.receiverHand = rh;
        }

        toObj() {
          return {
            "playerHand": this.getPlayerHand(),
            "receiverHand": this.getReceiverHand(),
          };
        }
      }

      // Global state for everything
      class State {
        constructor(gs, move) {
          this.gs = gs;
          this.move = move;
        }
        toObj() {
          return {
            "gs": this.gs,
            "move": this.move,
          }
        }
      }

      class AnimationController {
        constructor() {
          // Promise which resolves when the last move update completes.
          this.lastPendingAnimation = Promise.resolve();
        }
        enqueueAnimation(anim) {
          this.lastPendingAnimation = this.lastPendingAnimation
            .then((result) => anim());
        }

        promise() {
          return this.lastPendingAnimation;
        }
      }

      // Singleton
      const animationController = new AnimationController()

      const FINGERS_TO_X_TRANSLATE_PX = {
        1: 370,
        2: 200,
        3: 0,
        4: -160,
        5: -340,
      };

      const IN_PLAY_Y_TRANSLATE_PX = 124;


      // Controllers
      function applyMove(state) {
        const gs = state.gs
        const move = state.move
        // Given the current game state and Move,
        // apply the Move to the gamestate and update the UI
        // Returns the new game state
        const player = gs.T == "p1" ? gs.p1 : gs.p2;
        const receiver = gs.T == "p1" ? gs.p2 : gs.p1;
        const receiverStr = invertPlayer(gs.T);

        const playerFingers = player[move.getPlayerHand()];
        const receiverFingers = receiver[move.getReceiverHand()];
        receiver[move.getReceiverHand()] = (playerFingers + receiverFingers) % NUM_FINGERS;

        // Increment the turn
        gs.T = invertPlayer(gs.T);

        // The receive hand needs to be updated to the new value
        const receiverPh = receiverStr + move.getReceiverHand();
        const newReceiverFingers = receiver[move.getReceiverHand()]

        setHeaderText(`You played ${move.getPlayerHand()} -> ${move.getReceiverHand()}`)
        setFingersForHand(receiverPh, newReceiverFingers)
        // Reset our move.
        state.move = new Move();
        return state;
      }

      function setHeaderText(text) {
        const header = document.getElementById("header-text")
        header.innerText = text
      }
      function setFingersForHand(ph, fingers) {
        if (fingers == 0) {
          // SPEICAL CASE, TODO
        }
        const transX = FINGERS_TO_X_TRANSLATE_PX[fingers]
        const el = document.getElementById(ph);
        el.style.transform = `translate(${transX}px, ${IN_PLAY_Y_TRANSLATE_PX}px)`
      }

      function disableClicksForHand(ph) {
        const container = document.getElementById(ph + "-container");
        const img = document.getElementById(ph);
        container.style.cursor = "not-allowed";
        img.style.pointerEvents = "none";
      }

      function enableClicksForHand(ph) {
        const container = document.getElementById(ph + "-container");
        const img = document.getElementById(ph);
        container.style.cursor = "pointer";
        img.style.pointerEvents = null;
      }

      function disableClicksForPlayer(p) {
        disableClicksForHand(p + "rh");
        disableClicksForHand(p + "lh")
      }

      function enableClicksForPlayer(p) {
        enableClicksForHand(p + "rh");
        enableClicksForHand(p + "lh")
      }

      function invertPlayer(p) {
        if (p === "p1") {
          return "p2";
        } else {
          return "p1";
        }
      }

      function invertHand(h) {
        if (h === "lh") {
          return "rh";
        } else {
          return "lh";
        }
      }

      // Highlights the hand green
      function selectPlayerHand(p, h) {
        // p: string, Player name (p1 or p2)
        // h: string, hand name (lh or rh)
        const img = document.getElementById(p + h);
        img.src = "/static/hands_green.png"
      }

      // Highlights the hand red
      function selectReceiverHand(p, h) {
        // p: string, Player name (p1 or p2)
        // h: string, hand name (lh or rh)
        const img = document.getElementById(p + h);
        img.src = "/static/hands_red.png"
      }

      // Removes highlighting from a hand.
      function deselectHand(p, h) {
        // p: string, Player name (p1 or p2)
        // h: string, hand name (lh or rh)
        const img = document.getElementById(p + h);
        img.src = "/static/hands.png"
      }

      function deselectPlayer(p) {
        deselectHand(p, "lh");
        deselectHand(p, "rh");
      }

      function deselectAllAfterTimeout() {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            deselectPlayer("p1");
            deselectPlayer("p2");
            resolve();
          }, 500);
        });
      }

      // For now just select the hand.
      function addPlayerClickListener(p, h, state) {
        const elem = document.getElementById(p + h);

        elem.addEventListener('click', event => {
          // If NO hand selected, enable selecting the opponents hand.
          const move = state.move;
          if (!move.getPlayerHand()) {
            enableClicksForPlayer(invertPlayer(p));
          } 
          // If other hand is selected, deselect it.
          deselectHand(p, invertHand(h));
          selectPlayerHand(p, h);
          move.setPlayerHand(h);
        });

      }


      function addReceiverClickListener(p, h, state) {
        const elem = document.getElementById(p + h);

        elem.addEventListener('click', event => {
          const move = state.move;
          if (!!move.getReceiverHand() && move.getReceiverHand() !== h) {
            // If other hand is selected, deselect it.
            deselectHand(p, move.getReceiverHand());
          }
          selectReceiverHand(p, h)
          move.setReceiverHand(h)
          applyMove(state)
          // TODO: disable for both players? until computer makes his move?
          disableClicksForPlayer(p)
          // Deselct both players after a timeout
          // TODO: player is always player 1?
          animationController.enqueueAnimation(deselectAllAfterTimeout);
          // submitMove(state.gs);
        });
      }

      // Example POST method implementation:
      async function postData(url, body) {
        // Default options are marked with *
        const response = await fetch(url, {
          method: 'POST', // *GET, POST, PUT, DELETE, etc.
          mode: 'cors', // no-cors, *cors, same-origin
          credentials: 'same-origin', // include, *same-origin, omit
          headers: {
            'Content-Type': 'application/json'
          },
          body, // body data type must match "Content-Type" header
        });
        return response.json(); // parses JSON response into native JavaScript objects
      }

      function submitMove(gs) {
        postData("/move", gs.toJson()).then(resp => {
          console.log("Got response: " + resp);
        })
      }

      // Initialize UI state
      function initUiForPlayer(state) {
        addPlayerClickListener("p1", "lh", state)
        addPlayerClickListener("p1", "rh", state)
        addReceiverClickListener("p2", "lh", state)
        addReceiverClickListener("p2", "rh", state)

        enableClicksForPlayer("p1")
        disableClicksForPlayer("p2")
      }

      function init() {
        // Current global game state
        const gs = new GameState(
          new Player( 1, 1),
          new Player( 1, 1),
          "p1"
          );

        const move = new Move();
        const state = new State(gs, move);

        initUiForPlayer(state);

        return state;
      }


      function run() {
        const state = init();
      }

      run();
    </script>
    <style>
      .img-cache {
        display: none;
      }
      #header {
        margin-left: 100px;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 5px;
        width: 550px;
        height: 550px;
      }
      .container div {
        /*background-color: red;*/
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden
      }
      .container .grid-inner {
        width: 180px;
        height: 250px;
        overflow: hidden
      }
      /* Player 2*/ 
      #p2lh-container {
       transform: rotate(180deg) ;
      }

      #p2rh-container {
       transform: scaleX(-1) rotate(180deg) ;
      }
      /* Player 1 */ 
      #p1lh-container {
       transform:  scaleX(-1);
      }
    </style>
  </body>
</html>
